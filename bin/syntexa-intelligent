#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Syntexa Intelligent Autoloader
 * 
 * This script automatically discovers ALL classes in the project
 * and generates PSR-4 mappings without any manual configuration.
 */

require_once __DIR__ . '/../vendor/autoload.php';

use Syntexa\Core\IntelligentAutoloader;

echo "ğŸ§  Syntexa Intelligent Autoloader\n";
echo "=================================\n\n";

try {
    // Initialize intelligent autoloader
    echo "ğŸ” Discovering all classes...\n";
    IntelligentAutoloader::initialize();
    
    // Show discovered classes
    $classMap = IntelligentAutoloader::getClassMap();
    echo "\nğŸ“¦ Discovered " . count($classMap) . " classes:\n";
    
    foreach ($classMap as $className => $filePath) {
        $relativePath = str_replace(__DIR__ . '/../', '', $filePath);
        echo "   {$className} => {$relativePath}\n";
    }
    
    // Show namespaces
    $namespaces = IntelligentAutoloader::getNamespaces();
    echo "\nğŸ·ï¸  Found " . count($namespaces) . " namespaces:\n";
    
    foreach ($namespaces as $namespace) {
        echo "   {$namespace}\n";
    }
    
    // Generate PSR-4 mappings
    echo "\nğŸ”§ Generating PSR-4 mappings...\n";
    $mappings = IntelligentAutoloader::generatePsr4Mappings();
    
    echo "ğŸ“ Generated " . count($mappings) . " PSR-4 mappings:\n";
    foreach ($mappings as $namespace => $path) {
        echo "   {$namespace} => {$path}\n";
    }
    
    // Update composer.json
    echo "\nğŸ“ Updating composer.json...\n";
    $composerJsonPath = __DIR__ . '/../composer.json';
    $composer = json_decode(file_get_contents($composerJsonPath), true);
    
    $composer['autoload']['psr-4'] = $mappings;
    
    file_put_contents(
        $composerJsonPath,
        json_encode($composer, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES)
    );
    
    echo "âœ… Updated composer.json\n";
    
    // Regenerate autoloader
    echo "\nğŸ”„ Regenerating autoloader...\n";
    $output = shell_exec('cd ' . __DIR__ . '/.. && composer dump-autoload 2>&1');
    
    if ($output) {
        echo $output;
    }
    
    echo "\nâœ… Intelligent autoloader setup complete!\n";
    
} catch (\Throwable $e) {
    echo "âŒ Error: " . $e->getMessage() . "\n";
    exit(1);
}
