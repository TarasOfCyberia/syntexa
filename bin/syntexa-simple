#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Simple Syntexa Autoloader Generator
 * 
 * This script automatically discovers classes and generates
 * PSR-4 mappings without any manual configuration.
 */

echo "ğŸš€ Simple Syntexa Autoloader Generator\n";
echo "=====================================\n\n";

try {
    $projectRoot = __DIR__ . '/..';
    $mappings = [];
    
    // 1. Scan src/modules/*
    echo "ğŸ” Scanning src/modules/...\n";
    $modulesPath = $projectRoot . '/src/modules';
    if (is_dir($modulesPath)) {
        $modules = glob($modulesPath . '/*', GLOB_ONLYDIR);
        foreach ($modules as $module) {
            $moduleName = basename($module);
            $namespace = "Syntexa\\Modules\\" . ucfirst($moduleName) . "\\";
            $mappings[$namespace] = "src/modules/{$moduleName}/";
            echo "   ğŸ“¦ {$namespace} => src/modules/{$moduleName}/\n";
        }
    }
    
    // 2. Scan src/packages/*
    echo "ğŸ” Scanning src/packages/...\n";
    $packagesPath = $projectRoot . '/src/packages';
    if (is_dir($packagesPath)) {
        $packages = glob($packagesPath . '/*', GLOB_ONLYDIR);
        foreach ($packages as $package) {
            $packageName = basename($package);
            $namespace = "Syntexa\\Packages\\" . ucfirst($packageName) . "\\";
            $mappings[$namespace] = "src/packages/{$packageName}/";
            echo "   ğŸ“¦ {$namespace} => src/packages/{$packageName}/\n";
        }
    }
    
    // 3. Add Syntexa\Core
    echo "ğŸ” Adding Syntexa\\Core...\n";
    $mappings['Syntexa\\Core\\'] = 'vendor/syntexa/core/src/';
    echo "   ğŸ“¦ Syntexa\\Core\\ => vendor/syntexa/core/src/\n";
    
    // 4. Update composer.json
    echo "\nğŸ“ Updating composer.json...\n";
    $composerJsonPath = $projectRoot . '/composer.json';
    $composer = json_decode(file_get_contents($composerJsonPath), true);
    
    $composer['autoload']['psr-4'] = $mappings;
    
    file_put_contents(
        $composerJsonPath,
        json_encode($composer, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES)
    );
    
    echo "âœ… Updated composer.json with " . count($mappings) . " mappings\n";
    
    // 5. Regenerate autoloader
    echo "\nğŸ”„ Regenerating autoloader...\n";
    $output = shell_exec('cd ' . $projectRoot . ' && composer dump-autoload 2>&1');
    
    if ($output) {
        echo $output;
    }
    
    echo "\nâœ… Simple autoloader setup complete!\n";
    
} catch (\Throwable $e) {
    echo "âŒ Error: " . $e->getMessage() . "\n";
    exit(1);
}
